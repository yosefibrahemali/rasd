<?php

namespace App\Http\Controllers;

use App\Models\Transaction;
use Illuminate\Http\Request;

class RiskController extends Controller
{


    public function analyze(Request $request)
    {
        // ๐ฉ 1. ุงุณุชูุจุงู ุงูุจูุงูุงุช ุงููุงุฏูุฉ ูู ุงููุงุฌูุฉ ุฃู ุงูู API
        // ูุฐู ุงูุจูุงูุงุช ุชูุฑุณู ูู ุชุทุจูู ูุตุฑู ุงููููู
        $amount = $request->amount;        // ูููุฉ ุงููุจูุบ ุงูููุฑุณู ูู ุงูุนูููุฉ
        $recipient = $request->recipient;  // ุงุณู ุฃู ูููุฉ ุงููุณุชูู
        $hour = $request->hour;            // ุชูููุช ุงูุนูููุฉ (ูู 0 ุฅูู 23)

        // ๐ฉ 2. ุชุญุฏูุฏ ูุชูุณุท ูุงูุญุฑุงู ูุนูุงุฑู ุงูุชุฑุงุถู ููุนุงููุงุช ุงููุณุชุฎุฏู
        // ูู ุงููุธุงู ุงูุญูููู ูุชู ุญุณุงุจูุง ูู ุณุฌู ูุนุงููุงุช ุงููุณุชุฎุฏู ููุณู
        // ููุง ูุถุนูุง ููููุง ุชุฌุฑูุจูุฉ (mean = 50 , std = 20)
        $analyzedData = $this->getMeanStd();
        $mean = $analyzedData['mean'];
        $std = $analyzedData['std'];

        // $mean = 50;
        // $std = 20;

        // ๐ฉ 3. ุญุณุงุจ Z-Score
        // z = (ุงููููุฉ - ุงููุชูุณุท) / ุงูุงูุญุฑุงู ุงููุนูุงุฑู
        // ุงููุฏู: ูุนุฑูุฉ ูุฏู ุงูุญุฑุงู ุงููุจูุบ ุงูุญุงูู ุนู ุงููุจุงูุบ ุงููุนุชุงุฏุฉ ูููุณุชุฎุฏู
        $z = abs(($amount - $mean) / $std);

        // ๐ฉ 4. ุชุญููู z ุฅูู ุฏุฑุฌุฉ ูุฎุงุทุฑุฉ (0 - 100)
        // ุงุณุชุฎุฏููุง ุฏุงูุฉ ููุบุงุฑูุชููุฉ ูุงุนูุฉ ุชุฌุนู ุงูุฒูุงุฏุฉ ุงูุชุฏุฑูุฌูุฉ ูููุฎุงุทุฑุฉ
        // ูุซุงู: z=0 โ 0% ุฎุทุฑ ุ z=3 โ ุญูุงูู 80% ุฎุทุฑ ุ z>=6 โ 100% ุฎุทุฑ
        $amountRisk = min(100, (1 - exp(-0.6 * $z)) * 100);

        // ๐ฉ 5. ุชูููู ุฎุทุฑ ุงููุณุชูู (Recipient Risk)
        // ุฅุฐุง ูุงู ุงููุณุชูู ูุดุจูู ุฃู ุบูุฑ ูุนุฑูู (ูุซู unknownZ)
        // ูุฑูุน ูุณุชูู ุงูุฎุทุฑุ ูุฅูุง ุชููู ุงููุฎุงุทุฑุฉ ููุฎูุถุฉ
        $recipientRisk = $recipient === 'unknownZ' ? 90 : 20;

        // ๐ฉ 6. ุชูููู ุฎุทุฑ ุงูุชูููุช (Hour Risk)
        // ุงูุนูููุงุช ุงูุชู ุชุชู ูู ุฃููุงุช ุบูุฑ ูุนุชุงุฏุฉ (ููููุง ุฃู ูุชุฃุฎุฑูุง)
        // ุชููู ุฃูุซุฑ ุฎุทูุฑุฉ. ููุง ูููุณ ุจูุนุฏ ุงูุณุงุนุฉ ุนู ุงูุณุงุนุฉ 12 ุธูุฑูุง.
        // ูู ุณุงุนุฉ ุจุนุฏ 12 ุชุฒูุฏ ุงููุฎุงุทุฑุฉ ุจููุฏุงุฑ 4%
        $hourRisk = abs($hour - 12) * 4;

        // ๐ฉ 7. ุญุณุงุจ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ูููุฎุงุทุฑุฉ (Final Risk)
        // ูุฏูุฌ ุฌููุน ุงูุนูุงูู ุจุฃูุฒุงู ูุฎุชููุฉ ุญุณุจ ุฃูููุชูุง
        // 50% ูููุจูุบุ 30% ูููุณุชููุ 20% ููุชูููุช
        $final = 0.5 * $amountRisk + 0.3 * $recipientRisk + 0.2 * $hourRisk;

        // ๐ฉ 8. ุชุญุฏูุฏ ุงูุฅุฌุฑุงุก ุงูููุงุณุจ ุจูุงุกู ุนูู ุงููุชูุฌุฉ
        // ุฃูู ูู 40 โ ูุณููุญ (ALLOW)
        // ุจูู 40 ู 70 โ ูุญุชุงุฌ ุชุญูู ุฅุถุงูู (CHALLENGE)
        // 70 ุฃู ุฃูุซุฑ โ ุญุธุฑ ุงูุนูููุฉ (BLOCK)
        $action = $final < 40 ? 'ALLOW' : ($final < 70 ? 'CHALLENGE' : 'BLOCK');

        // ๐ฉ 9. ุฅุฑุฌุงุน ุงููุชูุฌุฉ ุจุตูุบุฉ JSON ุฅูู ุงููุงุฌูุฉ ุฃู ุงููุธุงู ุงูุขุฎุฑ
        // ูููู ุงุณุชุฎุฏุงููุง ูุนุฑุถูุง ูู Dashboard ุฃู ุญูุธูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        return response()->json([
            'final_risk_percent' => round($final, 2),  // ุงููุณุจุฉ ุงูููุงุฆูุฉ ูููุฎุงุทุฑุฉ
            'action' => $action                        // ุงูุฅุฌุฑุงุก ุงูููุชุฑุญ
        ]);
    }


    public function getMeanStd()
    {
        // ุงุญุตู ุนูู ุฌููุน ุงููุจุงูุบ ุงูุณุงุจูุฉ ูููุณุชุฎุฏู
        $transactions = Transaction::first()
            ->pluck('amount'); // ูุงุฆูุฉ ุงููุจุงูุบ ููุท

        // ุญุณุงุจ ุงููุชูุณุท
        $mean = $transactions->avg(); // ูููุฉ ูุชูุณุทุฉ

        // ุญุณุงุจ ุงูุงูุญุฑุงู ุงููุนูุงุฑู
        $std = sqrt($transactions->reduce(function ($carry, $item) use ($mean) {
            return $carry + pow($item - $mean, 2);
        }, 0) / $transactions->count());

        return response()->json([
            'mean' => $mean,  // ูุชูุณุท ุงููุจุงูุบ ุงููุนุชุงุฏุฉ
            'std' => $std    // ุงูุงูุญุฑุงู ุงููุนูุงุฑู ูููุจุงูุบ ุงููุนุชุงุฏุฉ
        ]);
    }

}
